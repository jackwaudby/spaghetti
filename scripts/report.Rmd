---
title: "`r toupper(params$workload)` Benchmark Results"
author: "Jack Waudby"
date: "`r Sys.Date()`"
output: pdf_document
params: 
  workload: ""
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("rjson")
library("data.table")
library("knitr")
library("dplyr")
options(scipen=999)
```

```{r load, include=FALSE}
sgt = fromJSON(file = "../results/tatp/sgt-sf1.json")
hit = fromJSON(file = "../results/tatp/hit-sf1.json")
tpl = fromJSON(file = "../results/tatp/2pl-sf1.json")
opt_hit = fromJSON(file = "../results/tatp/opt-hit-sf1.json")


dat = data.frame(
  protocol = c(sgt$protocol, hit$protocol, tpl$protocol, opt_hit$protocol),
  abort_rate = c(sgt$abort_rate, hit$abort_rate, tpl$abort_rate, opt_hit$abort_rate),
  throughput = c(sgt$throughput, hit$throughput, tpl$throughput, opt_hit$throughput),
  stringsAsFactors = FALSE
)

latency = data.frame(
  protocol = c(sgt$protocol, hit$protocol, tpl$protocol, opt_hit$protocol),
  min = c(sgt$min, hit$min, tpl$min, opt_hit$min),
  pc50 = c(
    sgt$`50th_percentile`,
    hit$`50th_percentile`,
    tpl$`50th_percentile`,
    opt_hit$`50th_percentile`
  ),
  pc75 = c(
    sgt$`90th_percentile`,
    hit$`90th_percentile`,
    tpl$`90th_percentile`,
    opt_hit$`90th_percentile`
  ),
  pc95 = c(
    sgt$`95th_percentile`,
    hit$`95th_percentile`,
    tpl$`95th_percentile`,
    opt_hit$`95th_percentile`
  ),
  pc99 = c(
    sgt$`99th_percentile`,
    hit$`99th_percentile`,
    tpl$`99th_percentile`,
    opt_hit$`99th_percentile`
  ),
  max = c(sgt$max, hit$max, tpl$max, opt_hit$max),
  stringsAsFactors = FALSE
)


sgt_aborts = data.frame(
  protocol = sgt$protocol,
  aborts = sgt$aborted,
  row_already_exists = sgt$abort_breakdown$row_already_exists,
  row_not_found = sgt$abort_breakdown$row_not_found,
  row_dirty = sgt$abort_breakdown$protocol_specific$SerializationGraph$row_dirty,
  row_deleted = sgt$abort_breakdown$protocol_specific$SerializationGraph$row_deleted,
   parent_aborted = sgt$abort_breakdown$protocol_specific$SerializationGraph$parent_aborted
)

hit_aborts = data.frame(
  protocol = hit$protocol,
  aborts = hit$aborted,
  row_already_exists = hit$abort_breakdown$row_already_exists,
  row_not_found = hit$abort_breakdown$row_not_found,
  row_dirty = hit$abort_breakdown$protocol_specific$HitList$row_dirty,
  row_deleted = hit$abort_breakdown$protocol_specific$HitList$row_deleted,
  hit = hit$abort_breakdown$protocol_specific$HitList$hit,
  pur_ab = hit$abort_breakdown$protocol_specific$HitList$pur_aborted,
  pur_ac = hit$abort_breakdown$protocol_specific$HitList$pur_active
)

tpl_aborts = data.frame(
  protocol = tpl$protocol,
  aborts = tpl$aborted,
  row_already_exists = tpl$abort_breakdown$row_already_exists,
  row_not_found = tpl$abort_breakdown$row_not_found,
  read_lock_denied = tpl$abort_breakdown$protocol_specific$TwoPhaseLocking$read_lock_denied,
  write_lock_denied = tpl$abort_breakdown$protocol_specific$TwoPhaseLocking$write_lock_denied
)

opt_hit_aborts = data.frame(
  protocol = opt_hit$protocol,
  aborts = opt_hit$aborted,
  row_already_exists = opt_hit$abort_breakdown$row_already_exists,
  row_not_found = opt_hit$abort_breakdown$row_not_found,
  row_dirty = opt_hit$abort_breakdown$protocol_specific$OptimisedHitList$row_dirty,
  row_deleted = opt_hit$abort_breakdown$protocol_specific$OptimisedHitList$row_deleted,
  hit = opt_hit$abort_breakdown$protocol_specific$OptimisedHitList$hit,
   pur_ab = opt_hit$abort_breakdown$protocol_specific$OptimisedHitList$pur_aborted,
  pur_ac = opt_hit$abort_breakdown$protocol_specific$OptimisedHitList$pur_active
)

# sgt
sgt_aborts = transpose(sgt_aborts) 
rownames(sgt_aborts) <- c('Protocol', 'Aborts','Row Exists','Row Not Found','Row Dirty','Row Deleted','Parent Aborted')
colnames(sgt_aborts) <- c("Value")
sgt_aborts <- tibble::rownames_to_column(sgt_aborts, "Metric")

# 2pl
tpl_aborts = transpose(tpl_aborts) 
rownames(tpl_aborts) <- c('Protocol', 'Aborts','Row Exists','Row Not Found','Read Lock Denied','Write Lock Denied')
colnames(tpl_aborts) <- c("Value")
tpl_aborts <- tibble::rownames_to_column(tpl_aborts, "Metric")

# hit
hit_aborts = transpose(hit_aborts) 
rownames(hit_aborts) <- c('Protocol', 'Aborts','Row Exists','Row Not Found','Row Dirty','Row Deleted','Hit','Pred Aborted','Pred Active')
colnames(hit_aborts) <- c("Value")
hit_aborts <- tibble::rownames_to_column(hit_aborts, "Metric")

# opt-hit
opt_hit_aborts = transpose(opt_hit_aborts) 
rownames(opt_hit_aborts) <- c('Protocol', 'Aborts','Row Exists','Row Not Found','Row Dirty','Row Deleted','Hit','Pred Aborted','Pred Active')
colnames(opt_hit_aborts) <- c("Value")
opt_hit_aborts <- tibble::rownames_to_column(opt_hit_aborts, "Metric")
```


## General
- Scale factor: `r sgt$sf`
- Max transactions: `r sgt$completed`
- Max duration: TODO
- Warmup: `r sgt$warmup`
- Non-uniform random generator: TODO

```{r general, echo=FALSE}
kable(dat, caption = paste0("TATP workload."),col.names = c('Protocol', 'Abort Rate (%)','Throughput (Txn/s)'))


kable(latency,
      caption = paste0("Latency (ms) for TATP workload."))
```

## Serialization Graph Testing Protocol
- Duration (mins): `r round(sgt$total_duration/60, digits=2)`
- Completed: `r sgt$completed`

```{r sgt, echo=FALSE}
kable(sgt_aborts, caption = paste0("SGT abort breakdown for TATP workload."))
```

## Two Phase Locking Protocol
- Duration (mins): `r round(tpl$total_duration/60, digits=2)`
- Completed: `r tpl$completed`
- Worker threads: TODO

```{r tpl, echo=FALSE}
kable(tpl_aborts, caption = paste0("2PL abort breakdown for TATP workload."))
```

## Wait-hit Protocol
- Duration (mins): `r round(hit$total_duration/60, digits=2)`
- Completed: `r hit$completed`
- Worker threads: TODO
- Garbage collection: TODO
- Garbage collection sleep: TODO

```{r hit, echo=FALSE}
kable(hit_aborts,caption = paste0("Wait-hit abort breakdown for TATP workload."))
```

## Optimised Wait-hit Protocol
- Duration (mins): `r round(opt_hit$total_duration/60, digits=2)`
- Completed: `r opt_hit$completed`
- Garbage collection: TODO
- Garbage collection sleep: TODO

```{r opt-hit, echo=FALSE}
kable(opt_hit_aborts,caption = paste0("Optimised wait-hit abort breakdown for TATP workload."))
```

